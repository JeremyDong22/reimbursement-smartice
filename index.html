<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeremy's Reimbursement Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Track and manage expense reimbursements with real-time sync">
    <meta name="theme-color" content="#1e3c72">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Reimbursement">
    
    <!-- PWA Links -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            border: 1px solid #2a2a2a;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            color: #ffffff;
            font-size: clamp(24px, 5vw, 32px);
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }
        
        .tabs {
            background: #242424;
            padding: 0;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #4a9eff;
            background: #1a1a1a;
            border-bottom-color: #4a9eff;
        }
        
        .tab:hover {
            color: #fff;
        }
        
        .report-info {
            background: #242424;
            padding: 20px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .info-value {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }
        
        .payoff-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .payoff-btn:hover {
            transform: translateY(-2px);
        }
        
        .table-container {
            padding: 20px 10px;
            background: #1a1a1a;
            overflow-x: auto;
            min-height: 400px;
        }
        
        .table-wrapper {
            min-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 800px;
        }
        
        th {
            background: #2a2a2a;
            color: #fff;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #3a3a3a;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #2a2a2a;
            color: #d0d0d0;
            font-size: 14px;
        }
        
        tr:hover:not(.category-header):not(.subtotal):not(.grand-total) {
            background: #242424;
        }
        
        .category-header td {
            background: #242424;
            color: #fff;
            font-weight: 600;
            font-size: 14px;
            padding: 12px 10px;
            border-left: 3px solid #4a9eff;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        
        .category-header:hover td {
            background: #2a2a2a;
        }
        
        .category-header.collapsed td::before {
            content: '▶ ';
            margin-right: 5px;
        }
        
        .category-header:not(.collapsed) td::before {
            content: '▼ ';
            margin-right: 5px;
        }
        
        .category-content {
            transition: all 0.3s ease;
        }
        
        .category-content.hidden {
            display: none;
        }
        
        .subtotal td {
            background: #1f2937;
            color: #60a5fa;
            font-weight: 600;
            border-top: 1px solid #3a3a3a;
        }
        
        .grand-total td {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            font-weight: 700;
            font-size: 16px;
            padding: 15px 10px;
            border: none;
        }
        
        .payment-cycle-header {
            background: #374151;
            color: #fbbf24;
            padding: 15px;
            margin: 20px 0 10px 0;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        
        .payment-cycle-header:hover {
            background: #4a5568;
        }
        
        .payment-cycle-header.collapsed::before {
            content: '▶ ';
            margin-right: 5px;
        }
        
        .payment-cycle-header:not(.collapsed)::before {
            content: '▼ ';
            margin-right: 5px;
        }
        
        .payment-cycle-content {
            transition: all 0.3s ease;
        }
        
        .payment-cycle-content.hidden {
            display: none;
        }
        
        .amount {
            text-align: right;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-weight: 500;
        }
        
        .edit-btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            margin-right: 5px;
        }
        
        .edit-btn:hover {
            background: #2e7dd2;
        }
        
        .delete-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .delete-btn:hover {
            background: #b91c1c;
        }
        
        .save-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            margin-right: 5px;
        }
        
        .save-btn:hover {
            background: #45a049;
        }
        
        .cancel-btn {
            background: #666;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            margin-right: 5px;
        }
        
        .cancel-btn:hover {
            background: #555;
        }
        
        .edit-input {
            padding: 4px 8px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 12px;
            width: 90%;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .edit-select {
            padding: 4px 8px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 12px;
            width: 100%;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .comment-text {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            font-size: 12px;
            color: #a0a0a0;
        }
        
        .comment-text:hover {
            white-space: normal;
            word-wrap: break-word;
        }
        
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 100;
            border: none;
            color: white;
            font-size: 24px;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(74, 222, 128, 0.6);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 30px 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #2a2a2a;
        }
        
        .modal-header {
            margin-bottom: 25px;
        }
        
        .modal-title {
            color: #fff;
            font-size: 20px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: #a0a0a0;
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: #242424;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 10px 12px;
            color: #fff;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #4a9eff;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4a9eff, #3b82f6);
            color: white;
        }
        
        .btn-secondary {
            background: #3a3a3a;
            color: #a0a0a0;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .summary-section {
            background: #242424;
            padding: 20px;
            border-top: 1px solid #2a2a2a;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
        }
        
        .summary-label {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .summary-value {
            color: #fff;
            font-size: 20px;
            font-weight: 700;
        }
        
        .total-card {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
        }
        
        .footer {
            background: #1a1a1a;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #2a2a2a;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 5px;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,.1);
            border-radius: 50%;
            border-top-color: #4a9eff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            color: #888;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px 5px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .report-info {
                padding: 15px;
            }
            
            .table-container {
                padding: 10px 5px;
            }
            
            th, td {
                padding: 8px 5px;
                font-size: 12px;
            }
            
            .fab {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px 15px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .edit-btn, .delete-btn, .save-btn, .cancel-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .edit-input, .edit-select {
                font-size: 11px;
                padding: 2px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💼 Jeremy's Reimbursement Tracker</h1>
            <div class="subtitle">Powered by Supabase • Real-time Sync</div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('current')">Current Expenses</button>
            <button class="tab" onclick="switchTab('history')">Payment History</button>
        </div>
        
        <div id="currentView">
            <div class="report-info">
                <div class="info-item">
                    <span class="info-label">Report Date</span>
                    <span class="info-value" id="reportDate">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Exchange Rate</span>
                    <span class="info-value" id="exchangeRate">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total Items</span>
                    <span class="info-value" id="totalItems">0</span>
                </div>
                <div class="info-item">
                    <button class="payoff-btn" onclick="markAsPaidOff()">💰 Mark as Paid Off</button>
                </div>
            </div>
            
            <div class="table-container">
                <div id="currentTableContent" class="table-wrapper">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading expenses...</p>
                    </div>
                </div>
            </div>

            <div class="summary-section">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">Direct RMB</div>
                        <div class="summary-value" id="directRMB">¥0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">USD Expenses</div>
                        <div class="summary-value" id="usdExpenses">$0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">USD → RMB</div>
                        <div class="summary-value" id="usdConverted">¥0.00</div>
                    </div>
                    <div class="total-card summary-card">
                        <div class="summary-label">Total Reimbursement</div>
                        <div class="summary-value" id="totalAmount">¥0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="historyView" style="display: none;">
            <div class="table-container">
                <div id="historyTableContent" class="table-wrapper">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading history...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <button class="download-btn" onclick="exportToCSV()">
                📊 Export Current CSV
            </button>
            <button class="download-btn" onclick="exportHistoryCSV()">
                📜 Export Full History
            </button>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="addBtn" onclick="openAddModal()">+</button>

    <!-- Add Expense Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Expense</h2>
            </div>
            <form id="expenseForm">
                <div class="form-group">
                    <label class="form-label">Expense Name *</label>
                    <input type="text" class="form-input" id="expenseName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select class="form-select" id="expenseCategory" required>
                        <option value="">Select Category</option>
                        <option value="✈️ Airline Tickets">✈️ Airline Tickets</option>
                        <option value="🚗 Local Transportation">🚗 Local Transportation</option>
                        <option value="💻 Software & Tools">💻 Software & Tools</option>
                        <option value="🏨 Accommodation">🏨 Accommodation</option>
                        <option value="🍽️ Meals">🍽️ Meals</option>
                        <option value="📱 Communication">📱 Communication</option>
                        <option value="📦 Equipment">📦 Equipment</option>
                        <option value="🔧 Other">🔧 Other</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Amount *</label>
                        <input type="number" step="0.01" class="form-input" id="expenseAmount" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency *</label>
                        <select class="form-select" id="expenseCurrency" required onchange="updateRMBPreview()">
                            <option value="RMB">RMB (¥)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" class="form-input" id="expenseDate" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Comment</label>
                    <textarea class="form-textarea" id="expenseComment" placeholder="Optional notes about this expense"></textarea>
                </div>
                
                <div class="form-group" id="rmbPreview" style="display: none;">
                    <label class="form-label">RMB Value (Auto-calculated)</label>
                    <div style="color: #4ade80; font-size: 18px; font-weight: 600;" id="rmbPreviewValue">¥0.00</div>
                </div>
            </form>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addExpense()">Add Expense</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://wdpeoyugsxqnpwwtkqsl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcGVveXVnc3hxbnB3d3RrcXNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNDgwNzgsImV4cCI6MjA1OTcyNDA3OH0.9bUpuZCOZxDSH3KsIu6FwWZyAvnV5xPJGNpO3luxWOE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let currentExpenses = [];
        let historyExpenses = [];
        let exchangeRate = 7.179186;
        let currentTab = 'current';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setToday();
            fetchExchangeRate();
            loadCurrentExpenses();
            loadHistoryExpenses();
            
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            }
            
            // Handle PWA install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                // Optionally show install button
                console.log('PWA can be installed');
            });
            
            // Check URL parameters for shortcuts
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'add') {
                setTimeout(() => openAddModal(), 500);
            } else if (urlParams.get('tab') === 'history') {
                document.querySelector('.tab:nth-child(2)').click();
            }
        });

        // Set today's date
        function setToday() {
            const today = new Date();
            document.getElementById('reportDate').textContent = today.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('expenseDate').value = today.toISOString().split('T')[0];
        }

        // Fetch exchange rate
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                exchangeRate = data.rates.CNY || 7.179186;
                document.getElementById('exchangeRate').textContent = `1 USD = ${exchangeRate.toFixed(6)} CNY`;
            } catch (error) {
                console.error('Failed to fetch exchange rate:', error);
                document.getElementById('exchangeRate').textContent = `1 USD = ${exchangeRate.toFixed(6)} CNY (cached)`;
            }
        }

        // Load current expenses
        async function loadCurrentExpenses() {
            try {
                const { data, error } = await supabase
                    .from('jeremy_reimbursement')
                    .select('*')
                    .eq('is_paid_off', false)
                    .order('date', { ascending: false });

                if (error) throw error;

                currentExpenses = data || [];
                document.getElementById('totalItems').textContent = currentExpenses.length;
                renderCurrentExpenses();
            } catch (error) {
                console.error('Error loading expenses:', error);
                document.getElementById('currentTableContent').innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading expenses</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Load history expenses
        async function loadHistoryExpenses() {
            try {
                const { data, error } = await supabase
                    .from('jeremy_reimbursement')
                    .select('*')
                    .eq('is_paid_off', true)
                    .order('paid_off_date', { ascending: false });

                if (error) throw error;

                historyExpenses = data || [];
                renderHistoryExpenses();
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Render current expenses
        function renderCurrentExpenses() {
            if (currentExpenses.length === 0) {
                document.getElementById('currentTableContent').innerHTML = `
                    <div class="empty-state">
                        <h3>No pending expenses</h3>
                        <p>Click the + button to add your first expense</p>
                    </div>
                `;
                updateSummary(0, 0);
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 5%;">Action</th>
                            <th style="width: 10%;">Date</th>
                            <th style="width: 15%;">Category</th>
                            <th style="width: 20%;">Name</th>
                            <th style="width: 12%;">Amount</th>
                            <th style="width: 8%;">Currency</th>
                            <th style="width: 12%;">RMB Value</th>
                            <th style="width: 18%;">Comment</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Group by category
            const categories = {};
            currentExpenses.forEach(expense => {
                if (!categories[expense.category]) {
                    categories[expense.category] = [];
                }
                categories[expense.category].push(expense);
            });

            let totalRMB = 0;
            let totalUSD = 0;

            Object.keys(categories).sort().forEach((category, index) => {
                // Category header with onclick handler
                const categoryId = `category-${index}`;
                html += `<tr class="category-header" onclick="toggleCategory('${categoryId}')"><td colspan="8">${category}</td></tr>`;

                let categoryTotal = 0;
                let categoryRows = '';
                
                categories[category].forEach(expense => {
                    const rmbValue = parseFloat(expense.rmb_value);
                    categoryRows += `
                        <tr id="row-${expense.id}" data-expense='${JSON.stringify(expense).replace(/'/g, "&#39;")}'>
                            <td>
                                <div id="actions-${expense.id}">
                                    <button class="edit-btn" onclick="editExpense(${expense.id})">Edit</button>
                                </div>
                            </td>
                            <td id="date-${expense.id}">${new Date(expense.date).toLocaleDateString()}</td>
                            <td id="category-${expense.id}">${expense.category}</td>
                            <td id="name-${expense.id}">${expense.name}</td>
                            <td id="amount-${expense.id}" class="amount">${parseFloat(expense.amount).toFixed(2)}</td>
                            <td id="currency-${expense.id}">${expense.currency}</td>
                            <td id="rmb-${expense.id}" class="amount">${rmbValue.toFixed(2)}</td>
                            <td id="comment-${expense.id}"><div class="comment-text" title="${expense.comment || ''}">${expense.comment || '-'}</div></td>
                        </tr>
                    `;

                    categoryTotal += rmbValue;
                    if (expense.currency === 'USD') {
                        totalUSD += parseFloat(expense.amount);
                    } else {
                        totalRMB += parseFloat(expense.amount);
                    }
                });

                // Wrap category content in a tbody with class for toggling
                html += `<tbody class="category-content" id="${categoryId}">${categoryRows}`;
                
                // Category subtotal
                html += `
                    <tr class="subtotal">
                        <td colspan="6">Category Subtotal</td>
                        <td class="amount">${categoryTotal.toFixed(2)}</td>
                        <td></td>
                    </tr>
                </tbody>`;
            });

            // Grand total
            const grandTotal = totalRMB + (totalUSD * exchangeRate);
            html += `
                <tr class="grand-total">
                    <td colspan="6">TOTAL REIMBURSEMENT AMOUNT</td>
                    <td class="amount" style="font-size: 18px;">¥${grandTotal.toFixed(2)}</td>
                    <td></td>
                </tr>
            `;

            html += '</tbody></table>';
            document.getElementById('currentTableContent').innerHTML = html;
            updateSummary(totalRMB, totalUSD);
        }

        // Render history expenses
        function renderHistoryExpenses() {
            if (historyExpenses.length === 0) {
                document.getElementById('historyTableContent').innerHTML = `
                    <div class="empty-state">
                        <h3>No payment history yet</h3>
                        <p>Paid expenses will appear here</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 10%;">Date</th>
                            <th style="width: 15%;">Category</th>
                            <th style="width: 25%;">Name</th>
                            <th style="width: 12%;">Amount</th>
                            <th style="width: 8%;">Currency</th>
                            <th style="width: 12%;">RMB Value</th>
                            <th style="width: 18%;">Comment</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Group by payment date
            const paymentCycles = {};
            historyExpenses.forEach(expense => {
                const paidDate = expense.paid_off_date ? 
                    new Date(expense.paid_off_date).toLocaleDateString() : 
                    'Unknown Date';
                
                if (!paymentCycles[paidDate]) {
                    paymentCycles[paidDate] = [];
                }
                paymentCycles[paidDate].push(expense);
            });

            Object.keys(paymentCycles).forEach((paidDate, index) => {
                const cycleId = `payment-cycle-${index}`;
                html += `<tr><td colspan="7" class="payment-cycle-header" onclick="togglePaymentCycle('${cycleId}')">💰 Paid on: ${paidDate}</td></tr>`;

                let cycleTotal = 0;
                let cycleRows = '';
                
                paymentCycles[paidDate].forEach(expense => {
                    const rmbValue = parseFloat(expense.rmb_value);
                    cycleRows += `
                        <tr>
                            <td>${new Date(expense.date).toLocaleDateString()}</td>
                            <td>${expense.category}</td>
                            <td>${expense.name}</td>
                            <td class="amount">${parseFloat(expense.amount).toFixed(2)}</td>
                            <td>${expense.currency}</td>
                            <td class="amount">${rmbValue.toFixed(2)}</td>
                            <td><div class="comment-text" title="${expense.comment || ''}">${expense.comment || '-'}</div></td>
                        </tr>
                    `;
                    cycleTotal += rmbValue;
                });

                // Wrap payment cycle content in a tbody with class for toggling
                html += `<tbody class="payment-cycle-content" id="${cycleId}">${cycleRows}`;
                
                html += `
                    <tr class="subtotal">
                        <td colspan="5">Cycle Total</td>
                        <td class="amount">¥${cycleTotal.toFixed(2)}</td>
                        <td></td>
                    </tr>
                </tbody>`;
            });

            html += '</tbody></table>';
            document.getElementById('historyTableContent').innerHTML = html;
        }

        // Update summary
        function updateSummary(totalRMB, totalUSD) {
            const usdConverted = totalUSD * exchangeRate;
            const grandTotal = totalRMB + usdConverted;

            document.getElementById('directRMB').textContent = `¥${totalRMB.toFixed(2)}`;
            document.getElementById('usdExpenses').textContent = `$${totalUSD.toFixed(2)}`;
            document.getElementById('usdConverted').textContent = `¥${usdConverted.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `¥${grandTotal.toFixed(2)}`;
        }

        // Switch tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'current') {
                document.getElementById('currentView').style.display = 'block';
                document.getElementById('historyView').style.display = 'none';
                document.getElementById('addBtn').style.display = 'flex';
            } else {
                document.getElementById('currentView').style.display = 'none';
                document.getElementById('historyView').style.display = 'block';
                document.getElementById('addBtn').style.display = 'none';
            }
        }

        // Add expense
        async function addExpense() {
            const name = document.getElementById('expenseName').value;
            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const currency = document.getElementById('expenseCurrency').value;
            const date = document.getElementById('expenseDate').value;
            const comment = document.getElementById('expenseComment').value;

            if (!name || !category || !amount || !currency || !date) {
                alert('Please fill in all required fields');
                return;
            }

            const rmbValue = currency === 'USD' ? amount * exchangeRate : amount;

            try {
                const { error } = await supabase
                    .from('jeremy_reimbursement')
                    .insert([{
                        name,
                        category,
                        amount,
                        currency,
                        rmb_value: rmbValue,
                        date,
                        comment,
                        is_paid_off: false
                    }]);

                if (error) throw error;

                closeAddModal();
                document.getElementById('expenseForm').reset();
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                loadCurrentExpenses();
            } catch (error) {
                alert('Error adding expense: ' + error.message);
            }
        }

        // Edit expense
        let editingId = null;
        
        function editExpense(id) {
            if (editingId && editingId !== id) {
                cancelEdit(editingId);
            }
            
            editingId = id;
            const row = document.getElementById(`row-${id}`);
            const expenseData = JSON.parse(row.dataset.expense);
            
            // Replace action buttons
            document.getElementById(`actions-${id}`).innerHTML = `
                <button class="save-btn" onclick="saveEdit(${id})">Save</button>
                <button class="cancel-btn" onclick="cancelEdit(${id})">Cancel</button>
                <button class="delete-btn" onclick="deleteExpense(${id})">Delete</button>
            `;
            
            // Make fields editable
            document.getElementById(`name-${id}`).innerHTML = `
                <input type="text" class="edit-input" id="edit-name-${id}" value="${expenseData.name}">
            `;
            
            document.getElementById(`amount-${id}`).innerHTML = `
                <input type="number" class="edit-input" id="edit-amount-${id}" value="${expenseData.amount}" step="0.01">
            `;
            
            document.getElementById(`currency-${id}`).innerHTML = `
                <select class="edit-select" id="edit-currency-${id}">
                    <option value="RMB" ${expenseData.currency === 'RMB' ? 'selected' : ''}>RMB</option>
                    <option value="USD" ${expenseData.currency === 'USD' ? 'selected' : ''}>USD</option>
                </select>
            `;
            
            document.getElementById(`comment-${id}`).innerHTML = `
                <input type="text" class="edit-input" id="edit-comment-${id}" value="${expenseData.comment || ''}">
            `;
            
            // Add event listener to recalculate RMB when amount or currency changes
            document.getElementById(`edit-amount-${id}`).addEventListener('input', () => updateRMBPreview(id));
            document.getElementById(`edit-currency-${id}`).addEventListener('change', () => updateRMBPreview(id));
        }
        
        function updateRMBPreview(id) {
            const amount = parseFloat(document.getElementById(`edit-amount-${id}`).value) || 0;
            const currency = document.getElementById(`edit-currency-${id}`).value;
            const rmbValue = currency === 'USD' ? amount * exchangeRate : amount;
            document.getElementById(`rmb-${id}`).textContent = rmbValue.toFixed(2);
        }
        
        function cancelEdit(id) {
            editingId = null;
            loadCurrentExpenses();
        }
        
        async function saveEdit(id) {
            const name = document.getElementById(`edit-name-${id}`).value;
            const amount = parseFloat(document.getElementById(`edit-amount-${id}`).value);
            const currency = document.getElementById(`edit-currency-${id}`).value;
            const comment = document.getElementById(`edit-comment-${id}`).value;
            
            if (!name || !amount) {
                alert('Name and amount are required');
                return;
            }
            
            const rmbValue = currency === 'USD' ? amount * exchangeRate : amount;
            
            try {
                const { error } = await supabase
                    .from('jeremy_reimbursement')
                    .update({
                        name,
                        amount,
                        currency,
                        rmb_value: rmbValue,
                        comment
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                editingId = null;
                loadCurrentExpenses();
            } catch (error) {
                alert('Error updating expense: ' + error.message);
            }
        }
        
        // Delete expense
        async function deleteExpense(id) {
            const passcode = prompt('Enter passcode to delete:');
            if (passcode !== '9633') {
                alert('Incorrect passcode');
                return;
            }

            try {
                const { error } = await supabase
                    .from('jeremy_reimbursement')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                editingId = null;
                loadCurrentExpenses();
            } catch (error) {
                alert('Error deleting expense: ' + error.message);
            }
        }

        // Mark as paid off
        async function markAsPaidOff() {
            if (currentExpenses.length === 0) {
                alert('No expenses to mark as paid');
                return;
            }

            const confirm = window.confirm(`Mark all ${currentExpenses.length} expenses as paid? Total: ${document.getElementById('totalAmount').textContent}`);
            if (!confirm) return;

            try {
                const { error } = await supabase
                    .from('jeremy_reimbursement')
                    .update({ 
                        is_paid_off: true,
                        paid_off_date: new Date().toISOString()
                    })
                    .eq('is_paid_off', false);

                if (error) throw error;

                alert('All expenses marked as paid!');
                loadCurrentExpenses();
                loadHistoryExpenses();
            } catch (error) {
                alert('Error marking as paid: ' + error.message);
            }
        }

        // Update RMB preview
        function updateRMBPreview() {
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const currency = document.getElementById('expenseCurrency').value;
            
            if (currency === 'USD' && amount > 0) {
                const rmbValue = amount * exchangeRate;
                document.getElementById('rmbPreviewValue').textContent = `¥${rmbValue.toFixed(2)}`;
                document.getElementById('rmbPreview').style.display = 'block';
            } else {
                document.getElementById('rmbPreview').style.display = 'none';
            }
        }

        // Modal functions
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('rmbPreview').style.display = 'none';
        }

        // Export functions
        function exportToCSV() {
            if (currentExpenses.length === 0) {
                alert('No expenses to export');
                return;
            }

            let csv = '\uFEFF';
            csv += 'Date,Category,Name,Amount,Currency,RMB Value,Comment\n';
            
            currentExpenses.forEach(expense => {
                csv += `"${expense.date}","${expense.category}","${expense.name}",${expense.amount},"${expense.currency}",${expense.rmb_value},"${expense.comment || ''}"\n`;
            });
            
            downloadCSV(csv, 'current_expenses');
        }

        function exportHistoryCSV() {
            if (historyExpenses.length === 0) {
                alert('No history to export');
                return;
            }

            let csv = '\uFEFF';
            csv += 'Date,Category,Name,Amount,Currency,RMB Value,Comment,Paid Date\n';
            
            historyExpenses.forEach(expense => {
                const paidDate = expense.paid_off_date ? new Date(expense.paid_off_date).toLocaleDateString() : '';
                csv += `"${expense.date}","${expense.category}","${expense.name}",${expense.amount},"${expense.currency}",${expense.rmb_value},"${expense.comment || ''}","${paidDate}"\n`;
            });
            
            downloadCSV(csv, 'expense_history');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Close modal on click outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
                document.getElementById('rmbPreview').style.display = 'none';
            }
        }

        // Toggle category visibility
        function toggleCategory(categoryId) {
            const categoryContent = document.getElementById(categoryId);
            const categoryHeader = categoryContent.previousElementSibling;
            
            if (categoryContent.classList.contains('hidden')) {
                categoryContent.classList.remove('hidden');
                categoryHeader.classList.remove('collapsed');
            } else {
                categoryContent.classList.add('hidden');
                categoryHeader.classList.add('collapsed');
            }
        }
        
        // Toggle payment cycle visibility
        function togglePaymentCycle(cycleId) {
            const cycleContent = document.getElementById(cycleId);
            const cycleHeader = cycleContent.previousElementSibling.querySelector('.payment-cycle-header');
            
            if (cycleContent.classList.contains('hidden')) {
                cycleContent.classList.remove('hidden');
                cycleHeader.classList.remove('collapsed');
            } else {
                cycleContent.classList.add('hidden');
                cycleHeader.classList.add('collapsed');
            }
        }
        
        // Update amount preview
        document.getElementById('expenseAmount').addEventListener('input', updateRMBPreview);
    </script>
</body>
</html>